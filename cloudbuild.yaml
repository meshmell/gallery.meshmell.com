steps:
  # Step to build the Docker container image
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        docker build \
          -t $_AR_HOSTNAME/$PROJECT_ID/cloud-run-source-deploy/$REPO_NAME/$_SERVICE_NAME:$COMMIT_SHA \
          --build-arg NEXT_PUBLIC_BASE_URL="$_NEXT_PUBLIC_BASE_URL" \
          --build-arg NEXT_PUBLIC_BASE_URL="$_NEXT_PUBLIC_BASE_URL" \
          --build-arg NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN="$_NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN" \
          --build-arg NEXT_PUBLIC_FIREBASE_APP_ID="$_NEXT_PUBLIC_FIREBASE_APP_ID" \
          --build-arg NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET="$_NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET" \
          --build-arg NEXT_PUBLIC_FIREBASE_PROJECT_ID="$_NEXT_PUBLIC_FIREBASE_PROJECT_ID" \
          --build-arg NEXT_PUBLIC_GA_MEASUREMENT_ID="$_NEXT_PUBLIC_GA_MEASUREMENT_ID" \
          --build-arg NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID="$_NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID" \
          --build-arg NEXT_PUBLIC_FIREBASE_API_KEY="$_NEXT_PUBLIC_FIREBASE_API_KEY" \
          --build-arg NEXT_PUBLIC_GCS_BUCKET_PUBLIC_URL="$_NEXT_PUBLIC_GCS_BUCKET_PUBLIC_URL" \
          --build-arg NEXT_PUBLIC_ENV_STATUS="$_NEXT_PUBLIC_ENV_STATUS" \
          --build-arg NEXT_PUBLIC_USE_GCS_EMULATOR="$_NEXT_PUBLIC_USE_GCS_EMULATOR" \
          --build-arg NEXT_PUBLIC_USE_FIREBASE_EMULATOR="$_NEXT_PUBLIC_USE_FIREBASE_EMULATOR" \
          --build-arg NEXT_PUBLIC_MESHMELL_GITHUB_REPOSITORY="$_NEXT_PUBLIC_MESHMELL_GITHUB_REPOSITORY" \
          --build-arg NEXT_PUBLIC_NUM_OF_MODEL_BY_PAGE="$_NEXT_PUBLIC_NUM_OF_MODEL_BY_PAGE" \
          --build-arg NEXT_PUBLIC_SUBDOMAIN_FOR_PRODUCTION="$_NEXT_PUBLIC_SUBDOMAIN_FOR_PRODUCTION" \
          --build-arg FIREBASE_ADMIN_PROJECT_ID="$_FIREBASE_ADMIN_PROJECT_ID" \
          --build-arg FIREBASE_ADMIN_CLIENT_EMAIL="$_FIREBASE_ADMIN_CLIENT_EMAIL" \
          --build-arg FIREBASE_ADMIN_DATABASE_URL="$_FIREBASE_ADMIN_DATABASE_URL" \
          --build-arg GCS_BUCKET_NAME="$_GCS_BUCKET_NAME" \
          --build-arg GCS_TYPE="$_GCS_TYPE" \
          --build-arg GCS_CLIENT_ID="$_GCS_CLIENT_ID" \
          --build-arg GCS_PROJECT_ID="$_GCS_PROJECT_ID" \
          --build-arg GCS_CLIENT_EMAIL="$_GCS_CLIENT_EMAIL" \
          --build-arg FIREBASE_ADMIN_PRIVATE_KEY="$$FIREBASE_ADMIN_PRIVATE_KEY" \
          --build-arg GCS_PRIVATE_KEY="$$GCS_PRIVATE_KEY" \
          .
    secretEnv: ['FIREBASE_ADMIN_PRIVATE_KEY', 'GCS_PRIVATE_KEY']
    id: Build

  # Push the container image to Container Registry
  - name: gcr.io/cloud-builders/docker
    args:
      [
        'push',
        '$_AR_HOSTNAME/$PROJECT_ID/cloud-run-source-deploy/$REPO_NAME/$_SERVICE_NAME:$COMMIT_SHA',
      ]
    id: Push

  # Deploy the container image to Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - '$_SERVICE_NAME'
      - '--image'
      - '$_AR_HOSTNAME/$PROJECT_ID/cloud-run-source-deploy/$REPO_NAME/$_SERVICE_NAME:$COMMIT_SHA'
      - '--region'
      - '$_DEPLOY_REGION'
    id: Deploy

images:
  - '$_AR_HOSTNAME/$PROJECT_ID/cloud-run-source-deploy/$REPO_NAME/$_SERVICE_NAME:$COMMIT_SHA'
options:
  logging: CLOUD_LOGGING_ONLY
substitutions:
  _AR_HOSTNAME: us-west1-docker.pkg.dev
  _PLATFORM: managed
  _SERVICE_NAME: meshmell
  _DEPLOY_REGION: us-west1
  _TRIGGER_ID: 770e62b3-0799-48df-9413-900b6777f844
  _NEXT_PUBLIC_BASE_URL: '${_NEXT_PUBLIC_BASE_URL}'
  _NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: '${_NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN}'
  _NEXT_PUBLIC_FIREBASE_APP_ID: '${_NEXT_PUBLIC_FIREBASE_APP_ID}'
  _NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: '${_NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET}'
  _NEXT_PUBLIC_FIREBASE_PROJECT_ID: '${_NEXT_PUBLIC_FIREBASE_PROJECT_ID}'
  _NEXT_PUBLIC_GA_MEASUREMENT_ID: '${_NEXT_PUBLIC_GA_MEASUREMENT_ID}'
  _NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: '${_NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID}'
  _NEXT_PUBLIC_FIREBASE_API_KEY: '${_NEXT_PUBLIC_FIREBASE_API_KEY}'
  _NEXT_PUBLIC_GCS_BUCKET_PUBLIC_URL: '${_NEXT_PUBLIC_GCS_BUCKET_PUBLIC_URL}'
  _NEXT_PUBLIC_ENV_STATUS: '${_NEXT_PUBLIC_ENV_STATUS}'
  _NEXT_PUBLIC_USE_GCS_EMULATOR: '${_NEXT_PUBLIC_USE_GCS_EMULATOR}'
  _NEXT_PUBLIC_USE_FIREBASE_EMULATOR: '${_NEXT_PUBLIC_USE_FIREBASE_EMULATOR}'
  _NEXT_PUBLIC_SUBDOMAIN_FOR_PRODUCTION: '${_NEXT_PUBLIC_SUBDOMAIN_FOR_PRODUCTION}'
  _FIREBASE_ADMIN_PROJECT_ID: '${_FIREBASE_ADMIN_PROJECT_ID}'
  _FIREBASE_ADMIN_CLIENT_EMAIL: '${_FIREBASE_ADMIN_CLIENT_EMAIL}'
  _FIREBASE_ADMIN_DATABASE_URL: '${_FIREBASE_ADMIN_DATABASE_URL}'
  _GCS_BUCKET_NAME: '${_GCS_BUCKET_NAME}'
  _GCS_TYPE: '${_GCS_TYPE}'
  _GCS_CLIENT_ID: '${_GCS_CLIENT_ID}'
  _GCS_PROJECT_ID: '${_GCS_PROJECT_ID}'
  _GCS_CLIENT_EMAIL: '${_GCS_CLIENT_EMAIL}'
  _NEXT_PUBLIC_MESHMELL_GITHUB_REPOSITORY: '${_NEXT_PUBLIC_MESHMELL_GITHUB_REPOSITORY}'
  _NEXT_PUBLIC_NUM_OF_MODEL_BY_PAGE: '${_NEXT_PUBLIC_NUM_OF_MODEL_BY_PAGE}'
availableSecrets:
  secretManager:
    - versionName: projects/705128422297/secrets/FIREBASE_ADMIN_PRIVATE_KEY/versions/latest
      env: FIREBASE_ADMIN_PRIVATE_KEY
    - versionName: projects/705128422297/secrets/GCS_PRIVATE_KEY/versions/latest
      env: GCS_PRIVATE_KEY
tags:
  - gcp-cloud-build-deploy-cloud-run
  - gcp-cloud-build-deploy-cloud-run-managed
  - meshmell
